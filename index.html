<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ashen's Domain</title>
  <meta name="description" content="Ashen’s hub." />
  <meta name="theme-color" content="#120a1c" />

  <style>
    :root{
      --font: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      --ashen-pink:#be0078;
      --ashen-purple:#8205b3;

      --bg0:#07060c;
      --bg1:#0b0812;

      --text: rgba(255,255,255,0.92);
      --textDim: rgba(255,255,255,0.72);

      --glass1: rgba(18,10,28,0.74);
      --glass2: rgba(10, 8,18,0.52);

      --stroke: rgba(255,255,255,0.10);

      --radius: 18px;
      --shadow: 0 18px 60px rgba(0,0,0,0.55);
      --glowP: rgba(130, 5,179,0.28);
      --glowM: rgba(190, 0,120,0.22);

      /* ultra-subtle emerald for hover/focus energy (optional future use) */
      --glowE: rgba(43,182,115,0.12);
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }

    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 12% 10%, rgba(190,0,120,0.22), transparent 55%),
        radial-gradient(900px 700px at 88% 22%, rgba(130,5,179,0.22), transparent 52%),
        radial-gradient(1200px 900px at 50% 90%, rgba(255,255,255,0.05), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .mist{
      position: fixed;
      inset: -40%;
      pointer-events:none;
      opacity: 0.22;
      filter: blur(22px);
      background:
        conic-gradient(from 180deg at 50% 50%,
          rgba(190,0,120,0.22),
          rgba(130,5,179,0.22),
          rgba(255,255,255,0.06),
          rgba(190,0,120,0.18)
        );
      animation: drift 14s ease-in-out infinite alternate;
      mix-blend-mode: screen;
    }
    @keyframes drift{
      0%{ transform: translate(-2%, -1%) rotate(-6deg) scale(1.04); }
      100%{ transform: translate(2%, 1%) rotate(6deg) scale(1.08); }
    }

    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px 16px;
    }

    .card{
      width: min(1040px, 100%);
      border-radius: calc(var(--radius) + 10px);
      background: linear-gradient(180deg, var(--glass1), var(--glass2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg,
        rgba(190,0,120,0.45),
        rgba(130,5,179,0.40),
        rgba(255,255,255,0.10)
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.7;
      pointer-events:none;
    }

    .cardInner{
      padding: 28px;
      position:relative;
      z-index:1;
    }

    .sections{
      display:flex;
      flex-direction: column;
      gap: 18px;
      margin-top: 0;
    }

    .sectionTitle{
      margin: 6px 0 12px 2px;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.82);
      opacity: 0.95;
    }

    .grid{
      display:grid;
      gap: 14px;
    }

    .grid--wishlists{
      grid-template-columns: 1fr 1fr;
    }

    .grid--socials{
      grid-template-columns: repeat(3, 1fr);
    }

    .grid--about{
      grid-template-columns: 1fr;
    }

    .grid--focus{
      grid-template-columns: 1fr;
    }

    .linkCard{
      display:block;
      text-decoration:none;
      color: var(--text);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      overflow:hidden;
      position:relative;
      transition: transform 140ms ease, border-color 140ms ease, box-shadow 140ms ease;
      outline: none;
      min-width: 0;
    }

    .linkCard::after{
      content:"";
      position:absolute;
      inset:-1px;
      background: radial-gradient(600px 180px at 20% 0%,
        rgba(190,0,120,0.25),
        transparent 55%
      );
      opacity: 0.7;
      pointer-events:none;
    }

    .linkCard:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.20);
      box-shadow:
        0 18px 44px rgba(0,0,0,0.45),
        0 0 26px rgba(130,5,179,0.18),
        0 0 26px rgba(190,0,120,0.14);
    }

    .linkCard:focus-visible{
      box-shadow:
        0 0 0 3px rgba(190,0,120,0.26),
        0 0 0 6px rgba(130,5,179,0.18),
        0 18px 44px rgba(0,0,0,0.45);
    }

    .linkCard.isText:hover{
      transform: none;
      border-color: rgba(255,255,255,0.12);
      box-shadow: none;
    }

    .lcInner{
      padding: 18px 18px 16px;
      position:relative;
      z-index:1;
    }

    .grid--socials .lcInner{
      padding: 16px 16px 14px;
    }

    .lcTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      min-width: 0;
    }

    .lcTitleRow{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .lcIcon{
      width: 18px;
      height: 18px;
      flex: 0 0 auto;
      opacity: 0.92;
      filter: drop-shadow(0 0 10px rgba(130,5,179,0.18)) drop-shadow(0 0 10px rgba(190,0,120,0.12));
    }

    .grid--socials .lcIcon{
      width: 17px;
      height: 17px;
    }

    .lcName{
      margin:0;
      font-weight: 700;
      font-size: 16px;
      letter-spacing: 0.2px;

      white-space: normal;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.2;
      min-width: 0;
    }

    .lcHint{
      margin: 10px 0 0;
      color: var(--textDim);
      font-size: 13px;
      line-height: 1.35;
    }

    .grid--socials .lcHint{
      margin-top: 8px;
      font-size: 12.5px;
    }

    .aboutText{
      margin: 10px 0 0;
      color: var(--textDim);
      font-size: 14px;
      line-height: 1.55;
      max-width: 85ch;
    }

    .focusGame{
      margin: 10px 0 0;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.2px;
      line-height: 1.25;
      color: rgba(255,255,255,0.90);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .pill{
      flex: 0 0 auto;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-size: 12px;
      color: rgba(255,255,255,0.86);
      white-space: nowrap;
    }

    .rail{
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width: 4px;
      background: linear-gradient(180deg, var(--ashen-pink), var(--ashen-purple));
      opacity: 0.95;
    }

    @media (max-width: 900px){
      .grid--socials{ grid-template-columns: 1fr; }
    }

    @media (max-width: 700px){
      .cardInner{ padding: 20px; }
      .grid--wishlists{ grid-template-columns: 1fr; }
      .grid--socials{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="mist" aria-hidden="true"></div>

  <main class="wrap">
    <section class="card" aria-label="Ashen hub">
      <div class="cardInner">
        <div class="sections" id="linksRoot" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <script>
    (async function init(){
      const rootEl = document.getElementById("linksRoot");

      const escapeHtml = (str) => String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");

      const iconSvg = (id) => {
        const common = 'class="lcIcon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"';
        switch(String(id || "").toLowerCase()){
          case "twitch":
            return `<svg ${common}><path d="M6 5h14v10l-4 4h-4l-2 2H8v-2H6V5z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/><path d="M10 9v5M14 9v5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>`;
          case "youtube":
            return `<svg ${common}><path d="M10 9.5l6 3.5-6 3.5v-7z" fill="currentColor"/><path d="M21 12c0 4-1 6-9 6S3 16 3 12 4 6 12 6s9 2 9 6z" stroke="currentColor" stroke-width="1.8"/></svg>`;
          case "tiktok":
            return `<svg ${common}><path d="M14 6c1.1 1.7 2.7 2.7 4.5 2.9v3c-1.8-.1-3.4-.8-4.5-1.7v6.1c0 2.6-2.1 4.7-4.7 4.7S4.6 20.6 4.6 18s2.1-4.7 4.7-4.7c.3 0 .6 0 .9.1v3c-.3-.1-.6-.2-.9-.2-1 0-1.8.8-1.8 1.8s.8 1.8 1.8 1.8 1.8-.8 1.8-1.8V6h3z" fill="currentColor"/></svg>`;
          case "steam":
            return `<svg ${common}><path d="M7.5 16.5l2.6 1.1a3 3 0 104-4l-1.1-2.6A4.8 4.8 0 1110 19.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><circle cx="15.8" cy="8.3" r="2.1" stroke="currentColor" stroke-width="1.8"/><circle cx="9.2" cy="17.2" r="1.2" fill="currentColor"/></svg>`;
          case "amazon":
            return `<svg ${common}><path d="M6.5 10.5c0-2.2 1.8-4 4-4H14c2.2 0 4 1.8 4 4v7H6.5v-7z" stroke="currentColor" stroke-width="1.8"/><path d="M9 10h6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M7 19.2c2.8 1.6 7.2 1.6 10 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>`;
          case "about":
            return `<svg ${common}><circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.8"/><path d="M5.5 20c1.4-3.4 4-5.2 6.5-5.2S17.1 16.6 18.5 20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>`;
          case "focus":
            return `<svg ${common}><path d="M7 17c4-1 6-3 7-7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M14 10l3 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M16 6h2a2 2 0 012 2v2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M8 20H6a2 2 0 01-2-2v-2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>`;
          default:
            return `<svg ${common}><circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="1.8"/><path d="M12 8v4l3 2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        }
      };

      const calculateLevel = () => {
        const birthDate = new Date(1989, 1, 28); // Feb = 1 (0-indexed)
        const today = new Date();

        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();

        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        return age;
      };

      rootEl.innerHTML = `
        <div class="linkCard" style="pointer-events:none; opacity:0.85;">
          <div class="lcInner">
            <div class="lcTop">
              <h2 class="lcName">Loading…</h2>
              <span class="pill">links.json</span>
            </div>
            <p class="lcHint">Booting Ashen hub</p>
          </div>
        </div>
      `;

      try{
        const jsonUrl = new URL("links.json", window.location.href);
        const res = await fetch(jsonUrl, { cache: "no-store" });

        if(!res.ok){
          throw new Error(`HTTP ${res.status} while fetching links.json`);
        }

        const data = await res.json();

        // Theme
        const root = document.documentElement;
        const theme = data.theme || {};
        if (theme.font) root.style.setProperty("--font", theme.font);
        if (theme.ashenPink) root.style.setProperty("--ashen-pink", theme.ashenPink);
        if (theme.ashenPurple) root.style.setProperty("--ashen-purple", theme.ashenPurple);
        if (Number.isFinite(theme.radius)) root.style.setProperty("--radius", `${theme.radius}px`);

        const sections = Array.isArray(data.sections) ? data.sections : [];
        const totalItems = sections.reduce((sum, s) => sum + (Array.isArray(s.items) ? s.items.length : 0), 0);

        if (totalItems === 0){
          rootEl.innerHTML = `
            <div class="linkCard" style="pointer-events:none; opacity:0.9;">
              <div class="lcInner">
                <div class="lcTop">
                  <h2 class="lcName">No links found</h2>
                  <span class="pill">Add items</span>
                </div>
                <p class="lcHint">Add items to sections[].items in links.json.</p>
              </div>
            </div>
          `;
          return;
        }

        const sectionHtml = sections.map(section => {
          const sectionName = String(section.name || "");
          const items = Array.isArray(section.items) ? section.items : [];
          if (items.length === 0) return "";

          const key = sectionName.trim().toLowerCase();
          const gridClass =
            key === "socials" ? "grid grid--socials" :
            key === "wishlists" ? "grid grid--wishlists" :
            key === "about" ? "grid grid--about" :
            key === "current focus" ? "grid grid--focus" :
            "grid grid--wishlists";

          const cards = items.map(item => {
            const id = String(item.id || "");
            const label = escapeHtml(item.label || "Link");

            const type = String(item.type || "").toLowerCase();
            const isText = (type === "text") || (typeof item.text === "string");
            const isPresence = (type === "presence");

            if (isPresence){
              return `
                <div class="linkCard isText" data-presence="1">
                  <span class="rail" aria-hidden="true"></span>
                  <div class="lcInner">
                    <div class="lcTop">
                      <div class="lcTitleRow">
                        ${iconSvg(id)}
                        <h3 class="lcName" title="${label}">${label}</h3>
                      </div>
                    </div>
                    <div class="focusGame" id="focusValue">Checking Discord…</div>
                  </div>
                </div>
              `;
            }

            if (isText){
              let rawText = item.text || "";
              const level = calculateLevel();
              rawText = rawText.replaceAll("{level}", level);

              const text = escapeHtml(rawText).replaceAll("\n", "<br>");
              return `
                <div class="linkCard isText">
                  <span class="rail" aria-hidden="true"></span>
                  <div class="lcInner">
                    <div class="lcTop">
                      <div class="lcTitleRow">
                        ${iconSvg(id)}
                        <h3 class="lcName" title="${label}">${label}</h3>
                      </div>
                    </div>
                    ${text ? `<div class="aboutText">${text}</div>` : ``}
                  </div>
                </div>
              `;
            }

            const url = String(item.url || "#");
            const hint = escapeHtml(item.hint || "");
            const pill = escapeHtml(item.pill || "Open");

            const rail = item.rail || {};
            let railStyle = "";
            if (rail.type === "solid" && rail.color){
              railStyle = `background:${rail.color};`;
            } else if (rail.type === "gradient" && rail.from && rail.to){
              railStyle = `background:linear-gradient(180deg, ${rail.from}, ${rail.to});`;
            } else {
              railStyle = `background:linear-gradient(180deg, var(--ashen-pink), var(--ashen-purple));`;
            }

            return `
              <a class="linkCard" href="${url}" target="_blank" rel="noopener noreferrer">
                <span class="rail" aria-hidden="true" style="${railStyle}"></span>
                <div class="lcInner">
                  <div class="lcTop">
                    <div class="lcTitleRow">
                      ${iconSvg(id)}
                      <h3 class="lcName" title="${label}">${label}</h3>
                    </div>
                    <span class="pill">${pill}</span>
                  </div>
                  ${hint ? `<p class="lcHint">${hint}</p>` : ``}
                </div>
              </a>
            `;
          }).join("");

          return `
            <section>
              <div class="sectionTitle">${escapeHtml(sectionName)}</div>
              <div class="${gridClass}">
                ${cards}
              </div>
            </section>
          `;
        }).join("");

        rootEl.innerHTML = sectionHtml || "";

        // --- Discord Presence → Current Focus (Lanyard) ---
        const focusEl = document.getElementById("focusValue");
        const discord = data.discord || {};
        const userId = String(discord.userId || "").trim();

        if (focusEl){
          if (!userId || userId === "PUT_YOUR_DISCORD_USER_ID_HERE"){
            focusEl.textContent = "Set your Discord userId in links.json";
          } else {
            try{
              // Lanyard REST endpoint: /v1/users/:id :contentReference[oaicite:1]{index=1}
              const pres = await fetch(`https://api.lanyard.rest/v1/users/${encodeURIComponent(userId)}`, { cache: "no-store" });
              if(!pres.ok) throw new Error(`HTTP ${pres.status}`);

              const payload = await pres.json();
              const activities = payload?.data?.activities || [];

              // Pick a "playing" activity; ignore Custom Status / Spotify.
              const playing = activities.find(a =>
                a && a.type === 0 &&
                typeof a.name === "string" &&
                a.name.toLowerCase() !== "spotify" &&
                a.name.toLowerCase() !== "custom status"
              );

              const game = playing?.name;

              if (game){
                focusEl.textContent = game;
              } else {
                // Could be offline/invisible/no activity enabled; Lanyard is opt-in via server join. :contentReference[oaicite:2]{index=2}
                focusEl.textContent = "Not currently showing an activity";
              }
            } catch (e){
              focusEl.textContent = "Couldn't read Discord status";
              console.error(e);
            }
          }
        }

      } catch (err) {
        const attempted = new URL("links.json", window.location.href).toString();
        rootEl.innerHTML = `
          <div class="linkCard" style="pointer-events:none; opacity:0.9;">
            <div class="lcInner">
              <div class="lcTop">
                <h2 class="lcName">Couldn't load links.json</h2>
                <span class="pill">Debug</span>
              </div>
              <p class="lcHint">
                Tried: ${escapeHtml(attempted)}<br/>
                Error: ${escapeHtml(String(err.message || err))}
              </p>
            </div>
          </div>
        `;
        console.error(err);
      }
    })();
  </script>
</body>
</html>